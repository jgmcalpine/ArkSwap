> [!IMPORTANT]
> üö® **WARNING: EXPERIMENTAL PROOF OF CONCEPT ‚Äî DO NOT USE WITH REAL FUNDS** üö®
>
> This software is strictly for **EDUCATIONAL PURPOSES ONLY**. It is designed exclusively for a local **Bitcoin Regtest** environment.
>
> *   **DO NOT** attempt to use this on Bitcoin Mainnet.
> *   **DO NOT** send real Bitcoin or real Ark VTXOs to any address generated by this application.
> *   **DO NOT** input real private keys. This application stores keys insecurely in the browser's `localStorage`.
>
> This code is **UNAUDITED** and contains intentional architectural shortcuts for demonstration purposes. Using this software with real value will result in **TOTAL LOSS OF FUNDS**.

# ArkSwap

**The Reference Implementation for Programmable Ark Transactions.**

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![TypeScript](https://img.shields.io/badge/language-TypeScript-3178c6.svg)
![Stack](https://img.shields.io/badge/stack-Next.js%20|%20NestJS%20|%20Docker-000000.svg)
![Assurance](https://img.shields.io/badge/testing-Playwright%20E2E-green.svg)

## üåä Overview

**ArkSwap** is a non-custodial liquidity bridge that demonstrates the programmable nature of the **Ark Layer 2 Protocol**. It allows users to atomically swap **Ark VTXOs** for **Bitcoin Layer 1** funds without trusting the service provider.

Unlike standard Ark wallets that only perform simple transfers, ArkSwap acts as a proof-of-concept for **Off-Chain Programmability**. It demonstrates how an Ark Service Provider (ASP) can accept a VTXO transfer encumbered by a custom **Taproot HTLC** (Hash Time-Locked Contract), enabling complex DeFi primitives to exist natively within the Ark protocol rounds.

**Key Differentiators:**
*   **Programmable L2:** Demonstrates VTXO transfers into custom Taproot scripts (not just P2PK).
*   **Trustless:** Swaps are secured by mathematical timelocks. If the Market Maker fails to pay, the protocol enforces a refund.
*   **Atomic:** The off-chain VTXO transfer and the on-chain L1 settlement are cryptographically linked.
*   **Resilient:** Built with reactive state management and automated session recovery.

## üìñ User Story: The Sovereign Exit

**Meet Elena**, a freelancer who gets paid in Bitcoin. She uses **Ark (Layer 2)** for her weekly paycheck because it's instant, private, and works even when her wallet is offline.

But Elena doesn't want to keep her life savings on a Layer 2 hot wallet. She wants to move them to her **Hardware Wallet (Layer 1)** for long-term security.

### The Problem
Moving money from L2 to L1 usually requires:
1.  **A Centralized Exchange:** Requires ID verification (KYC) and trusting a custodian.
2.  **Individual On-Chain Transactions:** Paying a variable mining fee every single week is expensive and permanently ties her on-chain addresses to her employer.

### The ArkSwap Solution
Elena uses ArkSwap as her **trustless bridge**.

1.  **The Batch:** She accumulates 4 weekly paychecks in her Ark Wallet.
2.  **The Swap:** She uses ArkSwap to convert all 4 VTXOs into a single Bitcoin L1 transaction sent directly to her cold storage.
3.  **The Savings:** Instead of paying 4 mining fees, she pays just **one**.

**The Critical Difference:**
ArkSwap is not an exchange. Elena sends her funds to a **Smart Contract (HTLC)**, not a company wallet.
*   **If it works:** She gets her Bitcoin on L1 instantly.
*   **If it fails:** The contract automatically unlocks, and she reclaims her funds via the "Refund" button.

**Elena moves from "Cash" (Ark) to "Gold" (Bitcoin) without ever trusting a third party, at the cadence that works best for her financial and security goals.**

## üõ† Tech Stack

This project is organized as a **TurboRepo** monorepo representing a complete L2 ecosystem.

*   **Apps:**
    *   `apps/web`: **Next.js 14** - The client-side **Ark Wallet**. Features **TanStack Query** for reactive state, **Zod** for runtime validation, and **Coin Control** for UTXO management.
    *   `apps/asp`: **NestJS** - A custom, lightweight **Ark Service Provider**. It coordinates rounds, manages the VTXO set, and validates programmable transfers via Schnorr signatures.
    *   `apps/api`: **NestJS** - The **Market Maker** backend. It quotes swaps, watches the ASP for locked funds, and broadcasts L1 Bitcoin transactions.
*   **Packages:**
    *   `packages/protocol`: Shared **TypeScript** library containing the core Bitcoin/Ark cryptographic logic (HTLC scripts, deterministic hashing, witness construction).
*   **Infrastructure:**
    *   **Docker:** Orchestrates the local "Universe": Bitcoin Core (Regtest), ASP, Postgres, and Redis.
    *   **Playwright:** End-to-End testing suite ensuring the critical path works from Lift to Swap to Exit.

## üöÄ Getting Started

Follow these steps to run the entire ArkSwap ecosystem locally.

### Prerequisites
*   **Node.js** (v18+) & **pnpm**
*   **Docker Desktop** (Running)

### 1. Installation
Clone the repo and install dependencies.
```bash
git clone https://github.com/jgmcalpine/arkswap.git
cd arkswap
pnpm install
```

### 2. Start the Infrastructure (The Universe)
Spin up the local Bitcoin Regtest node and Ark Service Provider (ASP).
```bash
cd docker
docker-compose up -d --build
```

### 3. Run the Development Servers
Start the Frontend (`localhost:3000`) and Backend (`localhost:3001`).
```bash
# From the root directory
# Note: Excludes the ASP since it runs in Docker
pnpm dev --filter=!@arkswap/asp
```

### 4. "God Mode" (Funding & Simulation)
Since this runs on Regtest, you control the blockchain. We provide scripts to mine blocks and fund wallets.

**Check Blockchain Status:**
```bash
./scripts/get-info.sh
```

**Mine Blocks (Time Travel):**
```bash
# Mines 101 blocks to mature coinbase rewards
./scripts/mine.sh 101
```

**Fund the Market Maker:**
```bash
# Sends 50 BTC to the Backend API wallet
curl -X POST http://localhost:3001/faucet/maker
```

**Run automated tests:**
```bash
# Validates the full user journey happy-path via headless browser
pnpm --filter @arkswap/web test:e2e
```

## üöÄ Roadmap to Mainnet (Call for Contributors)

We have built the "Steel Thread"‚Äîa fully functional Swap and Refund flow on Regtest. To elevate ArkSwap from a Reference Architecture to a Production Application, we are seeking contributors for the following critical infrastructure pieces.

If you are interested in tackling one of these, please open an Issue to discuss the implementation plan.

### 1. Persistence Layer (Priority: High)
*   **The Task:** Wire up the scaffolded **PostgreSQL** database to the NestJS Backend (`apps/api` and `apps/asp`).
*   **The Goal:** Ensure all VTXO states, active Swaps, and Round data survive a Docker container restart. Currently, this data exists only in memory.

### 2. Atomic Lifting (Priority: High)
*   **The Task:** Implement the "Trustless Entry" flow.
*   **The Goal:** Replace the current API-triggered lift with a true Bitcoin L1 listener. The User should broadcast a pre-signed funding transaction to L1, and the ASP should detect this via a Chain Indexer to automatically mint the VTXO, removing the need to trust the ASP's API.

### 3. Secure Key Management
*   **The Task:** Integrate a browser extension wallet (e.g., Alby, Unisat) or Hardware Wallet support.
*   **The Goal:** Remove `localStorage` key management entirely. The web app should request signatures (SIP-style) rather than holding private keys.

### 4. The "Double" Unilateral Exit
*   **The Task:** Implement the protocol-level exit strategy in the Client.
*   **The Goal:** Allow users to construct and broadcast the L1 "Tree Unfolding" transactions if the ASP goes offline. This requires tracking the Merkle Path for every VTXO in the client state.

### 5. Covenant Enforcement
*   **The Task:** Upgrade the ASP's `TransferService` to enforce graph topology.
*   **The Goal:** Ensure input VTXOs technically correspond to valid Connector outputs from previous rounds, preventing the ASP from equivocating or double-spending the liquidity pool.

### 6. External Wallet Integration (BIP-329 / WebLN Standard)
*   **The Task:** Decouple the "Wallet" from the "DApp."
*   **The Goal:** Instead of managing VTXOs and keys internally, ArkSwap should connect to an external Ark Wallet (like **Arkade**) via a standard provider interface (e.g., `window.ark` or similar). This allows users to bring their own identity and liquidity to the application, rather than creating a new ephemeral wallet for every session.

## ü§ù Contributing

We welcome contributions! Please note that this project deals with financial cryptography.
1.  **Strict Types:** We use TypeScript strict mode. No `any`.
2.  **Shared Logic:** All cryptographic logic belongs in `packages/protocol`, not in the apps.
3.  **Testing:** Any changes to `packages/protocol` must pass `pnpm test` with 100% coverage.

## üìÑ License

Distributed under the MIT License. See `LICENSE` for more information.