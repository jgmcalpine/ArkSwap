> [!IMPORTANT]
> üö® **WARNING: EXPERIMENTAL PROOF OF CONCEPT ‚Äî DO NOT USE WITH REAL FUNDS** üö®
>
> This software is strictly for **EDUCATIONAL PURPOSES ONLY**. It is designed exclusively for a local **Bitcoin Regtest** environment.
>
> *   **DO NOT** attempt to use this on Bitcoin Mainnet.
> *   **DO NOT** send real Bitcoin or real Ark VTXOs to any address generated by this application.
> *   **DO NOT** input real private keys. This application stores keys insecurely in the browser's `localStorage`.
>
> This code is **UNAUDITED** and contains intentional architectural shortcuts for demonstration purposes. Using this software with real value will result in **TOTAL LOSS OF FUNDS**.

# ArkSwap

**The Reference Implementation for Programmable Ark Transactions.**

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![TypeScript](https://img.shields.io/badge/language-TypeScript-3178c6.svg)
![Stack](https://img.shields.io/badge/stack-Next.js%20|%20NestJS%20|%20Docker-000000.svg)
![Assurance](https://img.shields.io/badge/testing-Playwright%20E2E-green.svg)

## üåä Overview

**ArkSwap** is a **research prototype** and **reference implementation** designed to explore the programmable nature of the **Ark Layer 2 Protocol**. It simulates a trustless atomic swap architecture where **Ark VTXOs** are exchanged for **Bitcoin Layer 1** funds within a controlled **Regtest** environment.

Unlike standard Ark wallet implementations that focus on simple value transfer, ArkSwap serves as an educational proof-of-concept for **Off-Chain Programmability**. It provides a working demonstration of how an Ark Service Provider (ASP) can accept VTXO transfers encumbered by custom **Taproot HTLCs** (Hash Time-Locked Contracts), illustrating how advanced conditional logic can exist natively within Ark protocol rounds.

**Key Differentiators:**
*   **Programmable L2:** Demonstrates VTXO transfers into custom Taproot scripts (not just P2PK).
*   **Trustless:** Swaps are secured by mathematical timelocks. If the Market Maker fails to pay, the protocol enforces a refund.
*   **Atomic:** The off-chain VTXO transfer and the on-chain L1 settlement are cryptographically linked.
*   **Resilient:** Built with reactive state management and automated session recovery.

## üìñ User Story: The Sovereign Exit

**Meet Elena**, a freelancer who gets paid in Bitcoin. She uses **Ark (Layer 2)** for her weekly paycheck because it's instant, private, and works even when her wallet is offline.

But Elena doesn't want to keep her life savings on a Layer 2 hot wallet. She wants to move them to her **Hardware Wallet (Layer 1)** for long-term security.

### The Problem
Moving money from L2 to L1 usually requires:
1.  **A Centralized Exchange:** Requires trusting a custodian.
2.  **Individual On-Chain Transactions:** Paying a variable mining fee every single week is expensive and permanently ties her on-chain addresses to her employer.

### The ArkSwap Solution
Elena uses ArkSwap as her **trustless bridge**.

1.  **The Batch:** She accumulates 4 weekly paychecks in her Ark Wallet.
2.  **The Swap:** She uses ArkSwap to convert all 4 VTXOs into a single Bitcoin L1 transaction sent directly to her cold storage.
3.  **The Savings:** Instead of paying 4 mining fees, she pays just **one**.

**The Critical Difference:**
ArkSwap is not an exchange. Elena sends her funds to a **Smart Contract (HTLC)**, not a company wallet.
*   **If it works:** She gets her Bitcoin on L1 instantly.
*   **If it fails:** The contract automatically unlocks, and she reclaims her funds via the "Refund" button.

**Elena moves from "Cash" (Ark) to "Gold" (Bitcoin) without ever trusting a third party, at the cadence that works best for her financial and security goals.**

## üõ† Tech Stack

This project is organized as a **TurboRepo** monorepo representing a complete L2 ecosystem.

*   **Apps:**
    *   `apps/web`: **Next.js 14** - The client-side **Ark Wallet**. Features **TanStack Query** for reactive state, **Zod** for runtime validation, and **Coin Control** for UTXO management.
    *   `apps/asp`: **NestJS** - A custom, lightweight **Ark Service Provider**. It coordinates rounds, manages the VTXO set, and validates programmable transfers via Schnorr signatures.
    *   `apps/api`: **NestJS** - The **Market Maker** backend. It quotes swaps, watches the ASP for locked funds, and broadcasts L1 Bitcoin transactions.
*   **Packages:**
    *   `packages/protocol`: Shared **TypeScript** library containing the core Bitcoin/Ark cryptographic logic (HTLC scripts, deterministic hashing, witness construction).
*   **Infrastructure:**
    *   **Docker:** Orchestrates the local "Universe": Bitcoin Core (Regtest), ASP, Postgres, and Redis.
    *   **Playwright:** End-to-End testing suite ensuring the critical path works from Lift to Swap to Exit.

## üöÄ Getting Started

Follow these steps to run the entire ArkSwap ecosystem locally.

### Prerequisites
*   **Node.js** (v18+) & **pnpm**
*   **Docker Desktop** (Running)

### 1. Installation
Clone the repo and install dependencies.
```bash
git clone https://github.com/jgmcalpine/arkswap.git
cd arkswap
pnpm install
```

### 2. Start the Infrastructure (The Universe)
Spin up the local Bitcoin Regtest node and Ark Service Provider (ASP).
```bash
cd docker
docker-compose up -d --build
```

### 3. Run the Development Servers
Start the Frontend (`localhost:3000`) and Backend (`localhost:3001`).
```bash
# From the root directory
# Note: Excludes the ASP since it runs in Docker
pnpm dev --filter=!@arkswap/asp
```

### 4. "God Mode" (Funding & Simulation)
Since this runs on Regtest, you control the blockchain. We provide scripts to mine blocks and fund wallets.

**Check Blockchain Status:**
```bash
./scripts/get-info.sh
```

**Mine Blocks (Time Travel):**
```bash
# Mines 101 blocks to mature coinbase rewards
./scripts/mine.sh 101
```

**Fund the Market Maker:**
```bash
# Sends 50 BTC to the Backend API wallet
curl -X POST http://localhost:3001/faucet/maker
```

## ‚ö†Ô∏è Simulated Infrastructure & Educational Abstractions

ArkSwap is designed exclusively as a local research environment. To isolate and demonstrate the specific cryptographic mechanics of Atomic Swaps, this repository intentionally abstracts several infrastructure 
components that would be required in a live protocol implementation.

The following differences exist between this simulation and the formal Ark Protocol specification:

### 1. The "Lift" (Onboarding)
* In this Simulation: Onboarding is triggered via a direct API call to the ASP (/v1/lift). The ASP credits the user immediately to facilitate rapid testing.

* Protocol Specification: A production ASP must never trust an API call. It must operate a Chain Indexer to detect pre-signed funding transactions on Bitcoin L1, minting VTXOs only after cryptographic verification of on-chain funding.

### 2. Round Settlement
* In this Simulation: The ASP "finalizes" rounds in memory, updating the local VTXO ledger instantly. It does not broadcast transaction data to the Bitcoin Regtest network.

* Protocol Specification: Security relies on the ASP aggregating transfers into a single Round Transaction and broadcasting it to the Bitcoin network. VTXOs are only valid once this transaction is confirmed or pinned in the mempool.

### 3. Covenant Enforcement
* In this Simulation: The ASP validates Ownership. It verifies that the Schnorr signature provided matches the public key embedded in the VTXO address.

* Protocol Specification: The ASP must also validate Topology. It must verify that every input VTXO is a valid leaf in the previous round's Connector Tree. This graph validation prevents the ASP from equivocating (double-spending) the underlying liquidity pool.

### 4. State Persistence
* In this Simulation: The ASP and Market Maker hold state in RAM. Restarting the Docker containers resets the ledger, ensuring a clean slate for every test run.

* Protocol Specification: All VTXO states and active swaps must be persisted to a durable database to prevent loss of user funds during infrastructure restarts.

### 5. Key Management
* In this Simulation: Private keys are generated and stored in the browser's localStorage for ease of use during testing.

* Protocol Specification: Application logic should be decoupled from key storage. A secure implementation would integrate with an external signer (Hardware Wallet or isolated Browser Extension) via a standard interface, ensuring the application layer never accesses raw private keys.

## ü§ù Contributing

We welcome contributions! Please note that this project deals with financial cryptography, so we enforce strict quality controls.

This repository contains Research Code. It is not intended for deployment. Pull Requests that attempt to remove Regtest constraints or add Mainnet configuration support will be closed immediately.

### Development Workflow

1.  **Strict Types:** We use TypeScript strict mode. No `any` casts are allowed.
2.  **Shared Logic:** All cryptographic logic belongs in `packages/protocol`, not in the apps.

### Verification (Running Tests)

Before pushing code, please run the following suites to ensure CI will pass.

**1. Code Quality (Fast)**
Runs linter, strict type checking, and protocol unit tests.
```bash
pnpm turbo lint
pnpm turbo type-check
pnpm --filter @arkswap/protocol test
```

**1. End-to-End Assurance (Slow)**
Runs the Playwright suite against the local Docker environment.
```bash
# Ensure Docker is running first
cd docker && docker-compose up -d

# Run E2E Tests
cd ..
pnpm --filter @arkswap/web test:e2e
```

## Project Structure
* **apps/web:** Next.js Frontend (Client)
* **apps/api:** NestJS Market Maker (Liquidity Provider)
* **apps/asp:** NestJS Ark Service Provider (Protocol Coordinator)
* **packages/protocol:** Shared Cryptography & Types

## üìÑ License

Distributed under the MIT License. See `LICENSE` for more information.